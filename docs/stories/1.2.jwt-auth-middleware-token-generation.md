# Story 1.2: JWT认证中间件和Token生成

## Status
Approved

## Story
**As a** developer,
**I want** to implement JWT authentication system and new generate-token API,
**so that** I can replace existing authentication while maintaining integration with backend services.

## Acceptance Criteria
1. JWT认证中间件实现，支持token验证和用户信息提取
2. 新的/api/auth/generate-token端点替换现有实现
3. 用户不存在时自动创建用户记录
4. 与现有后端认证服务集成，保持token生成逻辑
5. 错误处理和用户反馈机制

**Integration Verification:**
- IV1: 现有使用旧token的客户端不受影响（向后兼容期）
- IV2: 后端认证服务调用正常，响应时间符合现有标准
- IV3: 认证失败时的错误响应格式与现有模式一致

## Tasks / Subtasks

- [x] Task 1: JWT Dependencies and Configuration (AC: 1)
  - [x] Install jsonwebtoken library
  - [x] Configure JWT secret in environment variables
  - [x] Set up token expiration and refresh policies
  - [x] Create JWT utility functions for sign/verify

- [x] Task 2: JWT Authentication Middleware (AC: 1)
  - [x] Create auth middleware in src/middleware/auth.js
  - [x] Implement token verification logic
  - [x] Extract user information from valid tokens
  - [x] Handle invalid/expired tokens gracefully
  - [x] Add middleware to protected routes

- [x] Task 3: Replace Generate-Token Endpoint (AC: 2, 4)
  - [x] Update src/routes/auth.js to implement new logic
  - [x] Integrate user lookup/creation with Prisma (from Story 1.1)
  - [x] Call existing backend auth service for token generation
  - [x] Handle user creation when user doesn't exist (AC: 3)
  - [x] Maintain backward compatibility with existing request format

- [x] Task 4: User Creation Integration (AC: 3)
  - [x] Use Prisma user service from Story 1.1
  - [x] Implement "create if not exists" logic
  - [x] Handle database errors during user creation
  - [x] Ensure atomic operations for user lookup/creation

- [x] Task 5: Backend Service Integration (AC: 4)
  - [x] Maintain existing AUTH_BASE_URL service calls
  - [x] Preserve original token generation logic flow
  - [x] Handle backend service failures gracefully
  - [x] Add retry logic for backend service calls

- [x] Task 6: Error Handling and User Feedback (AC: 5, IV: 3)
  - [x] Standardize error response format with existing patterns
  - [x] Handle JWT validation errors
  - [x] Handle database connection errors
  - [x] Handle backend service errors
  - [x] Provide clear user feedback messages

- [x] Task 7: Integration and Compatibility (IV: 1, 2, 3)
  - [x] Ensure existing proxy middleware compatibility
  - [x] Test backward compatibility with old token format
  - [x] Verify response time requirements
  - [x] Test error response format consistency

- [x] Task 8: Testing Implementation
  - [x] Unit tests for JWT utilities and middleware
  - [x] Integration tests for generate-token endpoint
  - [x] User creation flow tests
  - [x] Backend service integration tests
  - [x] Error handling and edge case tests

## Dev Notes

### Previous Story Insights
From **Story 1.1** completion:
- Prisma client available at `src/db/client.js` or `src/database/client.js`
- User model with fields: id, email, name, created_at, updated_at
- Basic user CRUD operations: createUser, getUserById, updateUser, deleteUser
- Database error handling patterns established

### Technical Context from Current Project

**Current Auth Implementation:**
- Existing endpoint: `/api/auth/generate-token` [Source: src/routes/auth.js]
- Current logic: Simple validation + proxy to backend service [Source: src/routes/auth.js]
- Backend service URL: AUTH_BASE_URL=https://api.auth.example.com/v1 [Source: .env]
- Request format: {userId, email, name} [Source: src/routes/auth.js]

**Current Tech Stack:**
- Framework: Hono.js v4.9.8 [Source: package.json]
- Runtime: Node.js with CommonJS modules [Source: package.json]
- Database: Prisma + PostgreSQL (established in Story 1.1)
- Testing: Jest v30.1.3 [Source: package.json]

**Current Project Structure:**
```
src/
├── middleware/          # proxy.js, errorHandler.js
├── routes/             # auth.js (current implementation)
├── config/             # agents.js, config.js
├── db/                 # Prisma client (from Story 1.1)
└── services/           # userService.js (from Story 1.1)
```

### JWT Implementation Strategy

**New Dependencies Required:**
- `jsonwebtoken` for JWT creation and verification
- JWT secret configuration in .env

**File Locations:**
- **JWT Middleware**: `src/middleware/auth.js` (new)
- **JWT Utils**: `src/utils/jwt.js` (new)
- **Updated Auth Route**: `src/routes/auth.js` (modify existing)
- **Tests**: `tests/middleware/auth.test.js`, `tests/routes/auth.test.js`

**Integration Architecture:**
1. New JWT middleware for token validation
2. Updated generate-token endpoint with user creation
3. Maintain existing backend service calls
4. Use Prisma user operations from Story 1.1

### Backend Service Integration Details

**Current Backend Integration:**
- AUTH_BASE_URL service for actual token generation [Source: .env]
- Proxy middleware handles routing automatically [Source: src/app.js]
- Need to bypass proxy for new direct implementation

**New Integration Strategy:**
- Direct HTTP calls to AUTH_BASE_URL from generate-token endpoint
- Maintain existing request/response format for compatibility
- Add error handling for service unavailability

### Security and Configuration

**JWT Configuration:**
- JWT_SECRET environment variable (new)
- Token expiration policy (suggested: 24h access token)
- Refresh token strategy (optional for this story)

**Security Considerations:**
- Validate JWT secret exists on startup
- Secure token storage recommendations
- Handle token expiration gracefully

### Testing Strategy

**Test Framework**: Jest [Source: package.json]
**Test Categories:**
- JWT utility functions (sign/verify)
- Authentication middleware
- Generate-token endpoint integration
- User creation flow
- Backend service integration
- Error scenarios

**Integration with Previous Story:**
- Mock Prisma client for user operations
- Test database error scenarios
- Verify user creation logic

### Technical Constraints

**Backward Compatibility:**
- Maintain existing /api/auth/generate-token endpoint path
- Support existing request format: {userId, email, name}
- Preserve existing error response patterns

**Performance Requirements:**
- Token generation within existing response time standards
- Database lookup performance for user existence checks
- Backend service call timeout handling

**Error Handling:**
- Database connection failures should not break auth
- Backend service failures should return appropriate errors
- Invalid JWT tokens should return 401 Unauthorized

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*Implementation completed on 2025-09-29*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- JWT token generation test: Successfully created and verified tokens with HS256 algorithm
- Generate-token endpoint test: New user creation and token generation working correctly
- Authentication middleware test: Protected routes properly validate JWT tokens
- Backend service integration: Graceful handling of AUTH_BASE_URL service failures
- Proxy middleware integration: Successfully bypassed auth endpoints for local handling

### Completion Notes List
1. ✅ JWT authentication system fully implemented with jsonwebtoken library
2. ✅ New /api/auth/generate-token endpoint replaces proxy-only implementation
3. ✅ Automatic user creation when user doesn't exist in database
4. ✅ JWT middleware for protecting routes with token validation
5. ✅ Backend service integration with graceful failure handling
6. ✅ Comprehensive error handling with standardized response formats
7. ✅ Backward compatibility maintained with existing request format
8. ✅ Complete test suite covering all JWT functionality
9. ✅ Proxy middleware updated to bypass auth endpoints for local handling
10. ✅ Environment configuration for JWT secrets and expiration

### File List
**Core Implementation:**
- `src/utils/jwt.js` - JWT utility functions for token generation and verification
- `src/middleware/auth.js` - JWT authentication middleware with user context
- `src/routes/auth.js` - Updated auth routes with JWT implementation
- `src/routes/protected.js` - Demo protected routes using JWT middleware

**Configuration:**
- `.env` - Added JWT_SECRET and JWT_EXPIRES_IN configuration
- `.env.test` - Test environment JWT configuration
- `src/config/agents.js` - Added JWT_SECRET validation
- `src/middleware/proxy.js` - Updated to bypass auth endpoints
- `src/app.js` - Added protected routes integration

**Testing:**
- `tests/utils/jwt.test.js` - JWT utility function tests
- `tests/middleware/auth.test.js` - Authentication middleware tests
- `tests/routes/jwtAuth.test.js` - JWT auth routes integration tests

**Dependencies:**
- `package.json` - Added jsonwebtoken v9.0.2 dependency

## QA Results
*Results from QA Agent review will be added here after implementation*