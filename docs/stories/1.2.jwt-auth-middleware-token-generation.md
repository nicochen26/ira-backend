# Story 1.2: JWT认证中间件和Token生成

## Status
Approved

## Story
**As a** developer,
**I want** to implement JWT authentication system and new generate-token API,
**so that** I can replace existing authentication while maintaining integration with backend services.

## Acceptance Criteria
1. JWT认证中间件实现，支持token验证和用户信息提取
2. 新的/api/auth/generate-token端点替换现有实现
3. 用户不存在时自动创建用户记录
4. 与现有后端认证服务集成，保持token生成逻辑
5. 错误处理和用户反馈机制

**Integration Verification:**
- IV1: 现有使用旧token的客户端不受影响（向后兼容期）
- IV2: 后端认证服务调用正常，响应时间符合现有标准
- IV3: 认证失败时的错误响应格式与现有模式一致

## Tasks / Subtasks

- [ ] Task 1: JWT Dependencies and Configuration (AC: 1)
  - [ ] Install jsonwebtoken library
  - [ ] Configure JWT secret in environment variables
  - [ ] Set up token expiration and refresh policies
  - [ ] Create JWT utility functions for sign/verify

- [ ] Task 2: JWT Authentication Middleware (AC: 1)
  - [ ] Create auth middleware in src/middleware/auth.js
  - [ ] Implement token verification logic
  - [ ] Extract user information from valid tokens
  - [ ] Handle invalid/expired tokens gracefully
  - [ ] Add middleware to protected routes

- [ ] Task 3: Replace Generate-Token Endpoint (AC: 2, 4)
  - [ ] Update src/routes/auth.js to implement new logic
  - [ ] Integrate user lookup/creation with Prisma (from Story 1.1)
  - [ ] Call existing backend auth service for token generation
  - [ ] Handle user creation when user doesn't exist (AC: 3)
  - [ ] Maintain backward compatibility with existing request format

- [ ] Task 4: User Creation Integration (AC: 3)
  - [ ] Use Prisma user service from Story 1.1
  - [ ] Implement "create if not exists" logic
  - [ ] Handle database errors during user creation
  - [ ] Ensure atomic operations for user lookup/creation

- [ ] Task 5: Backend Service Integration (AC: 4)
  - [ ] Maintain existing AUTH_BASE_URL service calls
  - [ ] Preserve original token generation logic flow
  - [ ] Handle backend service failures gracefully
  - [ ] Add retry logic for backend service calls

- [ ] Task 6: Error Handling and User Feedback (AC: 5, IV: 3)
  - [ ] Standardize error response format with existing patterns
  - [ ] Handle JWT validation errors
  - [ ] Handle database connection errors
  - [ ] Handle backend service errors
  - [ ] Provide clear user feedback messages

- [ ] Task 7: Integration and Compatibility (IV: 1, 2, 3)
  - [ ] Ensure existing proxy middleware compatibility
  - [ ] Test backward compatibility with old token format
  - [ ] Verify response time requirements
  - [ ] Test error response format consistency

- [ ] Task 8: Testing Implementation
  - [ ] Unit tests for JWT utilities and middleware
  - [ ] Integration tests for generate-token endpoint
  - [ ] User creation flow tests
  - [ ] Backend service integration tests
  - [ ] Error handling and edge case tests

## Dev Notes

### Previous Story Insights
From **Story 1.1** completion:
- Prisma client available at `src/db/client.js` or `src/database/client.js`
- User model with fields: id, email, name, created_at, updated_at
- Basic user CRUD operations: createUser, getUserById, updateUser, deleteUser
- Database error handling patterns established

### Technical Context from Current Project

**Current Auth Implementation:**
- Existing endpoint: `/api/auth/generate-token` [Source: src/routes/auth.js]
- Current logic: Simple validation + proxy to backend service [Source: src/routes/auth.js]
- Backend service URL: AUTH_BASE_URL=https://api.auth.example.com/v1 [Source: .env]
- Request format: {userId, email, name} [Source: src/routes/auth.js]

**Current Tech Stack:**
- Framework: Hono.js v4.9.8 [Source: package.json]
- Runtime: Node.js with CommonJS modules [Source: package.json]
- Database: Prisma + PostgreSQL (established in Story 1.1)
- Testing: Jest v30.1.3 [Source: package.json]

**Current Project Structure:**
```
src/
├── middleware/          # proxy.js, errorHandler.js
├── routes/             # auth.js (current implementation)
├── config/             # agents.js, config.js
├── db/                 # Prisma client (from Story 1.1)
└── services/           # userService.js (from Story 1.1)
```

### JWT Implementation Strategy

**New Dependencies Required:**
- `jsonwebtoken` for JWT creation and verification
- JWT secret configuration in .env

**File Locations:**
- **JWT Middleware**: `src/middleware/auth.js` (new)
- **JWT Utils**: `src/utils/jwt.js` (new)
- **Updated Auth Route**: `src/routes/auth.js` (modify existing)
- **Tests**: `tests/middleware/auth.test.js`, `tests/routes/auth.test.js`

**Integration Architecture:**
1. New JWT middleware for token validation
2. Updated generate-token endpoint with user creation
3. Maintain existing backend service calls
4. Use Prisma user operations from Story 1.1

### Backend Service Integration Details

**Current Backend Integration:**
- AUTH_BASE_URL service for actual token generation [Source: .env]
- Proxy middleware handles routing automatically [Source: src/app.js]
- Need to bypass proxy for new direct implementation

**New Integration Strategy:**
- Direct HTTP calls to AUTH_BASE_URL from generate-token endpoint
- Maintain existing request/response format for compatibility
- Add error handling for service unavailability

### Security and Configuration

**JWT Configuration:**
- JWT_SECRET environment variable (new)
- Token expiration policy (suggested: 24h access token)
- Refresh token strategy (optional for this story)

**Security Considerations:**
- Validate JWT secret exists on startup
- Secure token storage recommendations
- Handle token expiration gracefully

### Testing Strategy

**Test Framework**: Jest [Source: package.json]
**Test Categories:**
- JWT utility functions (sign/verify)
- Authentication middleware
- Generate-token endpoint integration
- User creation flow
- Backend service integration
- Error scenarios

**Integration with Previous Story:**
- Mock Prisma client for user operations
- Test database error scenarios
- Verify user creation logic

### Technical Constraints

**Backward Compatibility:**
- Maintain existing /api/auth/generate-token endpoint path
- Support existing request format: {userId, email, name}
- Preserve existing error response patterns

**Performance Requirements:**
- Token generation within existing response time standards
- Database lookup performance for user existence checks
- Backend service call timeout handling

**Error Handling:**
- Database connection failures should not break auth
- Backend service failures should return appropriate errors
- Invalid JWT tokens should return 401 Unauthorized

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*Results from QA Agent review will be added here after implementation*