# Story 1.3: 团队管理API

## Status
Approved

## Story
**As a** user,
**I want** to be able to create teams and manage team members,
**so that** I can collaborate with other users for investment research.

## Acceptance Criteria
1. 团队表(teams)和成员关系表(team_members)创建
2. 创建团队API实现，支持团队名称和描述
3. 成员加入团队API实现，支持邀请机制
4. 团队成员列表和权限管理
5. 团队删除和成员移除功能

**Integration Verification:**
- IV1: JWT认证中间件正确验证团队操作权限
- IV2: 数据库事务确保团队-成员关系一致性
- IV3: API响应格式与现有路由风格保持一致

## Tasks / Subtasks

- [ ] Task 1: Team Data Models Creation (AC: 1)
  - [ ] Add Team model to prisma/schema.prisma
  - [ ] Add TeamMember model to prisma/schema.prisma
  - [ ] Define relationships between User, Team, and TeamMember models
  - [ ] Generate and run database migrations
  - [ ] Test model relationships in database

- [ ] Task 2: Team Service Layer (AC: 2, 5)
  - [ ] Create src/services/teamService.js
  - [ ] Implement createTeam function
  - [ ] Implement getTeamById function
  - [ ] Implement updateTeam function
  - [ ] Implement deleteTeam function
  - [ ] Add proper error handling and validation

- [ ] Task 3: Team Member Service Layer (AC: 3, 4, 5)
  - [ ] Create src/services/teamMemberService.js
  - [ ] Implement addMemberToTeam function
  - [ ] Implement removeMemberFromTeam function
  - [ ] Implement getTeamMembers function
  - [ ] Implement getUserTeams function
  - [ ] Add role-based permissions logic

- [ ] Task 4: Team Management API Routes (AC: 2, 3, 4, 5)
  - [ ] Create src/routes/teams.js
  - [ ] POST /api/teams - Create team endpoint
  - [ ] GET /api/teams/:id - Get team details endpoint
  - [ ] PUT /api/teams/:id - Update team endpoint
  - [ ] DELETE /api/teams/:id - Delete team endpoint
  - [ ] POST /api/teams/:id/members - Add member endpoint
  - [ ] DELETE /api/teams/:id/members/:userId - Remove member endpoint
  - [ ] GET /api/teams/:id/members - List team members endpoint
  - [ ] GET /api/users/teams - List user's teams endpoint

- [ ] Task 5: Authentication Integration (IV: 1)
  - [ ] Apply JWT auth middleware to all team routes
  - [ ] Implement team ownership verification
  - [ ] Add permission checks for team operations
  - [ ] Handle unauthorized access scenarios

- [ ] Task 6: Database Transaction Management (IV: 2)
  - [ ] Implement team creation with owner assignment transaction
  - [ ] Implement team deletion with member cleanup transaction
  - [ ] Add error handling for transaction failures
  - [ ] Test transaction rollback scenarios

- [ ] Task 7: API Response Formatting (IV: 3)
  - [ ] Ensure consistent JSON response format
  - [ ] Implement standard error response structure
  - [ ] Add proper HTTP status codes
  - [ ] Include relevant metadata in responses

- [ ] Task 8: Integration with Main App
  - [ ] Register team routes in src/app.js
  - [ ] Ensure routes work with existing middleware stack
  - [ ] Test compatibility with proxy middleware
  - [ ] Verify health check still functions

- [ ] Task 9: Testing Implementation
  - [ ] Unit tests for team and team member services
  - [ ] Integration tests for all API endpoints
  - [ ] Authentication and authorization tests
  - [ ] Database transaction tests
  - [ ] Error handling tests

## Dev Notes

### Previous Stories Insights

**From Story 1.1 (Database Infrastructure):**
- Prisma client available at `src/db/client.js` or `src/database/client.js`
- User model established with fields: id, email, name, created_at, updated_at
- Database migration system using Prisma Migrate
- Basic user CRUD operations: createUser, getUserById, updateUser, deleteUser

**From Story 1.2 (JWT Authentication):**
- JWT authentication middleware at `src/middleware/auth.js`
- JWT utilities at `src/utils/jwt.js`
- User authentication and token validation established
- JWT_SECRET environment variable configured
- Authentication error handling patterns established

### Technical Context from Current Project

**Current Tech Stack:**
- Framework: Hono.js v4.9.8 [Source: package.json]
- Database: Prisma + PostgreSQL [Source: Stories 1.1, 1.2]
- Authentication: JWT with jsonwebtoken library [Source: Story 1.2]
- Testing: Jest v30.1.3 [Source: package.json]

**Updated Project Structure:**
```
src/
├── middleware/          # proxy.js, errorHandler.js, auth.js (from Story 1.2)
├── routes/             # auth.js (updated in Story 1.2)
├── services/           # userService.js (from Story 1.1)
├── db/                 # Prisma client (from Story 1.1)
├── utils/              # jwt.js (from Story 1.2)
└── config/             # agents.js, config.js
```

### Team Data Model Design

**Team Model Structure:**
```prisma
model Team {
  id          String      @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  ownerId     String
  owner       User        @relation("TeamOwner", fields: [ownerId], references: [id])
  members     TeamMember[]
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member") // "owner", "admin", "member"
  joinedAt  DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}
```

**User Model Updates:**
```prisma
// Add to existing User model
model User {
  // ... existing fields
  ownedTeams    Team[]       @relation("TeamOwner")
  teamMembers   TeamMember[]
}
```

### API Endpoint Design

**Team Management Endpoints:**
- `POST /api/teams` - Create team (authenticated user becomes owner)
- `GET /api/teams/:id` - Get team details (members can view)
- `PUT /api/teams/:id` - Update team (owner/admin only)
- `DELETE /api/teams/:id` - Delete team (owner only)
- `POST /api/teams/:id/members` - Add member (owner/admin only)
- `DELETE /api/teams/:id/members/:userId` - Remove member (owner/admin or self)
- `GET /api/teams/:id/members` - List members (team members only)
- `GET /api/users/teams` - List user's teams (authenticated user)

### Permission System Design

**Role Hierarchy:**
- **Owner**: Full control (update team, add/remove members, delete team)
- **Admin**: Management permissions (add/remove members, update team details)
- **Member**: Basic access (view team, view members)

**Permission Checks:**
- All endpoints require JWT authentication
- Team operations require team membership verification
- Owner/admin operations require role verification
- Users can always remove themselves from teams

### Integration Strategy

**Authentication Integration:**
- Use JWT middleware from Story 1.2 for all protected routes
- Extract user ID from JWT token for permission checks
- Implement team-specific authorization logic

**Database Integration:**
- Use Prisma client from Story 1.1 for all database operations
- Implement database transactions for multi-table operations
- Follow established error handling patterns

**API Integration:**
- Follow existing Hono.js route patterns
- Maintain consistent response format with existing endpoints
- Use existing error handling middleware

### Error Handling Strategy

**Database Errors:**
- Foreign key constraint violations (user/team not found)
- Unique constraint violations (user already in team)
- Transaction failures during multi-step operations

**Authorization Errors:**
- Unauthorized access (no JWT token)
- Forbidden operations (insufficient permissions)
- Team not found or access denied

**Validation Errors:**
- Invalid team name/description
- Invalid user ID for team operations
- Missing required fields

### Testing Strategy

**Test Framework**: Jest [Source: package.json]
**Test Categories:**
- **Unit Tests**: Team and TeamMember service functions
- **Integration Tests**: API endpoints with authentication
- **Database Tests**: Model relationships and transactions
- **Authorization Tests**: Permission verification
- **Error Tests**: All error scenarios and edge cases

**Test File Locations:**
- `tests/services/teamService.test.js`
- `tests/services/teamMemberService.test.js`
- `tests/routes/teams.test.js`
- `tests/models/team.test.js`

### Technical Constraints

**Performance Considerations:**
- Efficient queries for team member lookups
- Pagination for large team member lists
- Proper indexing on foreign keys

**Security Considerations:**
- Validate all user inputs
- Prevent unauthorized team access
- Secure team member enumeration

**Scalability Considerations:**
- Support for large teams
- Efficient permission checking
- Database query optimization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*Results from QA Agent review will be added here after implementation*