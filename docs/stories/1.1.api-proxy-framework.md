# Story 1.1: API Proxy Framework

## Status
Ready for Review

## Story
**As a** API consumer/developer,
**I want** to route API requests through a configurable proxy to backend agent services,
**so that** I can centrally manage API access with flexible backend agent switching without changing client code.

## Acceptance Criteria
1. Environment configuration supports 2 backend agent services (Invest-Research-Agent and Hemera-Agent) with full base path URLs
2. Active agent selection is configurable via ACTIVE_AGENT environment variable (values: "invest-research" or "hemera")
3. All API requests (except /health) are proxied to the currently active agent
4. Health check endpoint can verify connectivity to both configured agents
5. Request/response logging is implemented for debugging purposes
6. All HTTP methods (GET, POST, PUT, DELETE, PATCH, etc.) are supported
7. All request headers are passed through to the target agent
8. Original request body and query parameters are preserved in proxy requests

## Tasks / Subtasks

- [x] Task 1: Environment Configuration Setup (AC: 1, 2)
  - [x] Add agent service URLs to .env.example (INVEST_RESEARCH_AGENT_URL, HEMERA_AGENT_URL)
  - [x] Add ACTIVE_AGENT configuration to .env.example
  - [x] Create config helper to load and validate agent configurations
  - [x] Add validation for required environment variables on startup

- [x] Task 2: Proxy Middleware Implementation (AC: 3, 6, 7, 8)
  - [x] Create proxy middleware using Hono's routing capabilities
  - [x] Implement request forwarding logic with active agent URL resolution
  - [x] Ensure all headers are passed through to target service
  - [x] Preserve request body and query parameters in forwarded requests
  - [x] Support all HTTP methods (GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD)

- [x] Task 3: Health Check Enhancement (AC: 4)
  - [x] Extend existing /health endpoint to include agent connectivity checks
  - [x] Implement health check requests to both configured agents
  - [x] Return status information for each agent service
  - [x] Handle timeout scenarios for unresponsive agents

- [x] Task 4: Request/Response Logging (AC: 5)
  - [x] Implement detailed request logging (method, path, headers, body)
  - [x] Implement response logging (status, headers, response time)
  - [x] Add error logging for failed proxy attempts
  - [x] Ensure sensitive headers are not logged (if any exist)

- [x] Task 5: Error Handling and Edge Cases
  - [x] Handle network errors when contacting target agents
  - [x] Return appropriate HTTP status codes for proxy failures
  - [x] Handle malformed requests gracefully
  - [x] Add proper error messages for configuration issues

- [x] Task 6: Testing Implementation (AC: 1-8)
  - [x] Unit tests for config loading and validation
  - [x] Integration tests for proxy functionality with mock agents
  - [x] Health check endpoint tests
  - [x] Request/response logging tests
  - [x] Error handling tests

## Dev Notes

### Technical Implementation Context
- **Framework**: Built on existing Hono framework established in current codebase
- **Project Structure**: Follow existing src/ directory structure (middleware/, config/, routes/)
- **Environment Management**: Extend existing dotenv configuration pattern

### Configuration Requirements
- Environment variables should follow existing naming conventions
- Agent URLs must include full base paths (e.g., "https://api.example.com/v1")
- ACTIVE_AGENT values: "invest-research" or "hemera"
- Configuration validation should happen at application startup

### Proxy Implementation Details
- Use Hono's built-in request/response handling
- Exclude /health endpoint from proxy routing (keep existing health check)
- Preserve original request structure completely
- Use native fetch API for outbound requests to agent services

### Error Handling Strategy
- Network timeouts should return 502 Bad Gateway
- Invalid configuration should prevent application startup
- Missing active agent configuration should return 500 Internal Server Error
- Log all errors with sufficient detail for debugging

### Logging Requirements
- Extend existing Hono logger middleware for proxy-specific logging
- Include request ID or correlation ID if possible
- Log format should be consistent with existing application logging
- Performance consideration: avoid logging large payloads in production

### Testing
- Testing framework: Jest (already configured)
- Test location: tests/ directory following existing structure
- Mock agent services for integration testing
- Test coverage should include all acceptance criteria

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-26 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug log references needed - all implementation completed successfully.

### Completion Notes List
- All 6 tasks completed successfully with comprehensive testing
- Environment configuration setup with validation
- Proxy middleware implemented with full HTTP method support
- Enhanced health check includes agent connectivity verification
- Request/response logging implemented with security considerations
- Error handling covers network failures, malformed requests, and configuration issues
- 53 tests passing across all components (config, proxy, health, logging, errors)
- All acceptance criteria met and verified through tests

### File List
**Created Files:**
- `.env.example` - Environment configuration template
- `src/config/agents.js` - Agent configuration management
- `src/middleware/proxy.js` - Core proxy middleware
- `tests/config/agents.test.js` - Configuration tests
- `tests/middleware/proxy.test.js` - Proxy functionality tests
- `tests/middleware/proxy-logging.test.js` - Logging tests
- `tests/middleware/proxy-errors.test.js` - Error handling tests
- `tests/health-enhanced.test.js` - Enhanced health check tests

**Modified Files:**
- `src/app.js` - Added agent validation, proxy middleware, enhanced health endpoint
- `tests/app.test.js` - Updated tests for new proxy behavior

## QA Results
*Results from QA Agent review will be added here after implementation*