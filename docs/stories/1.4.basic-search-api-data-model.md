# Story 1.4: 基础搜索API和数据模型

## Status
Approved

## Story
**As a** user,
**I want** to be able to initiate search requests and save search results,
**so that** I can track my research history and results.

## Acceptance Criteria
1. 搜索表(searches)创建，包含topic、用户关联、时间戳
2. 搜索结果表(search_results)创建，存储报告和思考过程
3. 发起搜索API实现，记录搜索元数据
4. 搜索数据持久化和查询接口
5. 用户权限验证和数据关联

**Integration Verification:**
- IV1: 搜索API使用JWT认证，正确识别用户身份
- IV2: 数据库查询性能不影响其他API响应时间
- IV3: 搜索数据结构支持未来的扩展需求

## Tasks / Subtasks

- [ ] Task 1: Search Data Models Creation (AC: 1, 2)
  - [ ] Add Search model to prisma/schema.prisma
  - [ ] Add SearchResult model to prisma/schema.prisma
  - [ ] Define relationships between User, Search, and SearchResult models
  - [ ] Generate and run database migrations
  - [ ] Test model relationships and constraints

- [ ] Task 2: Search Service Layer (AC: 3, 4)
  - [ ] Create src/services/searchService.js
  - [ ] Implement createSearch function
  - [ ] Implement getSearchById function
  - [ ] Implement updateSearchStatus function
  - [ ] Implement getUserSearches function
  - [ ] Add search validation and error handling

- [ ] Task 3: Search Results Service Layer (AC: 2, 4)
  - [ ] Create src/services/searchResultService.js
  - [ ] Implement addSearchResult function
  - [ ] Implement updateSearchResult function
  - [ ] Implement getSearchResults function
  - [ ] Add result content validation and sanitization

- [ ] Task 4: Search API Routes (AC: 3, 4, 5)
  - [ ] Create src/routes/search.js
  - [ ] POST /api/search - Create search endpoint
  - [ ] GET /api/search/:id - Get search details endpoint
  - [ ] PUT /api/search/:id/status - Update search status endpoint
  - [ ] POST /api/search/:id/results - Add search results endpoint
  - [ ] GET /api/search/:id/results - Get search results endpoint

- [ ] Task 5: Authentication and Authorization (AC: 5, IV: 1)
  - [ ] Apply JWT auth middleware to all search routes
  - [ ] Implement search ownership verification
  - [ ] Add user association for all search operations
  - [ ] Handle unauthorized access scenarios

- [ ] Task 6: Data Persistence and Query Optimization (AC: 4, IV: 2)
  - [ ] Implement efficient search queries with pagination
  - [ ] Add database indexes for search performance
  - [ ] Optimize search result storage and retrieval
  - [ ] Add search metadata caching strategies

- [ ] Task 7: Future-Proof Data Structure (IV: 3)
  - [ ] Design extensible search metadata schema
  - [ ] Add support for search tags and categories
  - [ ] Implement flexible search result content storage
  - [ ] Add versioning support for search results

- [ ] Task 8: Integration with Main App
  - [ ] Register search routes in src/app.js
  - [ ] Ensure routes work with existing middleware stack
  - [ ] Test compatibility with proxy middleware
  - [ ] Verify health check includes search system status

- [ ] Task 9: Testing Implementation
  - [ ] Unit tests for search and search result services
  - [ ] Integration tests for all API endpoints
  - [ ] Authentication and ownership tests
  - [ ] Performance tests for database queries
  - [ ] Error handling and validation tests

## Dev Notes

### Previous Stories Insights

**From Story 1.1 (Database Infrastructure):**
- Prisma client available at `src/db/client.js` or `src/database/client.js`
- User model established with fields: id, email, name, created_at, updated_at
- Database migration patterns using Prisma Migrate
- Error handling patterns for database operations

**From Story 1.2 (JWT Authentication):**
- JWT authentication middleware at `src/middleware/auth.js`
- JWT utilities at `src/utils/jwt.js` for token validation
- User authentication and token validation established
- Authentication error handling patterns

**From Story 1.3 (Team Management):**
- Team and TeamMember models with user relationships
- Role-based permission patterns established
- Database transaction management patterns
- API response formatting standards

### Technical Context from Current Project

**Current Tech Stack:**
- Framework: Hono.js v4.9.8 [Source: package.json]
- Database: Prisma + PostgreSQL [Source: Stories 1.1-1.3]
- Authentication: JWT with jsonwebtoken library [Source: Story 1.2]
- Testing: Jest v30.1.3 [Source: package.json]

**Updated Project Structure:**
```
src/
├── middleware/          # proxy.js, errorHandler.js, auth.js
├── routes/             # auth.js, teams.js
├── services/           # userService.js, teamService.js, teamMemberService.js
├── db/                 # Prisma client
├── utils/              # jwt.js
└── config/             # agents.js, config.js
```

### Search Data Model Design

**Search Model Structure:**
```prisma
model Search {
  id            String        @id @default(cuid())
  topic         String
  description   String?
  status        SearchStatus  @default(INITIATED)
  userId        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  metadata      Json?         // Extensible metadata for future features
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  results       SearchResult[]

  @@index([userId, createdAt])
  @@index([status])
}

model SearchResult {
  id            String       @id @default(cuid())
  searchId      String
  resultType    ResultType   @default(THINKING)
  content       String       @db.Text
  contentFormat String       @default("text") // "text", "markdown", "json"
  sequence      Int          @default(0)
  createdAt     DateTime     @default(now())
  metadata      Json?        // Extensible metadata
  search        Search       @relation(fields: [searchId], references: [id], onDelete: Cascade)

  @@index([searchId, sequence])
  @@unique([searchId, sequence])
}

enum SearchStatus {
  INITIATED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ResultType {
  THINKING     // AI thinking process
  REPORT       // Final markdown report
  INTERMEDIATE // Intermediate results
  ERROR        // Error information
}
```

**User Model Updates:**
```prisma
// Add to existing User model
model User {
  // ... existing fields from previous stories
  searches      Search[]
}
```

### API Endpoint Design

**Search Management Endpoints:**
- `POST /api/search` - Create new search (authenticated user)
- `GET /api/search/:id` - Get search details (owner only)
- `PUT /api/search/:id/status` - Update search status (owner only)
- `POST /api/search/:id/results` - Add search results (owner only)
- `GET /api/search/:id/results` - Get search results (owner only)

**Request/Response Examples:**

**Create Search:**
```json
POST /api/search
{
  "topic": "Tesla Q3 2024 Financial Analysis",
  "description": "Comprehensive analysis of Tesla's Q3 2024 financial performance"
}
```

**Add Search Result:**
```json
POST /api/search/:id/results
{
  "resultType": "THINKING",
  "content": "Analyzing Tesla's revenue growth patterns...",
  "contentFormat": "text",
  "sequence": 1
}
```

### Search System Architecture

**Search Lifecycle:**
1. **INITIATED**: User creates search with topic
2. **PROCESSING**: System (or external service) processes search
3. **COMPLETED**: Final report generated and stored
4. **FAILED**: Error occurred during processing
5. **CANCELLED**: User cancelled the search

**Result Types:**
- **THINKING**: AI thinking process content
- **REPORT**: Final markdown report
- **INTERMEDIATE**: Intermediate analysis results
- **ERROR**: Error messages or debug information

### Performance and Scalability Design

**Database Optimization:**
- Index on (userId, createdAt) for user search lists
- Index on searchId for result queries
- Index on status for system-wide search monitoring
- Unique constraint on (searchId, sequence) for result ordering

**Content Storage Strategy:**
- Use PostgreSQL TEXT type for large content
- Support multiple content formats (text, markdown, json)
- Extensible metadata using JSON columns

**Query Optimization:**
- Pagination support for search lists
- Efficient result ordering by sequence
- Lazy loading of search content

### Integration Strategy

**Authentication Integration:**
- Use JWT middleware from Story 1.2 for all protected routes
- Extract user ID from JWT token for search ownership
- Implement search-specific authorization logic

**Database Integration:**
- Use Prisma client from Story 1.1 for all database operations
- Follow transaction patterns established in Story 1.3
- Maintain consistent error handling patterns

**API Integration:**
- Follow Hono.js route patterns from previous stories
- Maintain consistent response format
- Use existing error handling middleware

### Future Extension Points

**Extensible Metadata:**
- Search tags and categories
- Search complexity scores
- Processing time tracking
- Cost tracking for external services

**Team Integration (Future):**
- Team-shared searches
- Search collaboration features
- Team search permissions

**External Service Integration (Future):**
- Integration with AI analysis services
- Real-time search processing
- Search result streaming (Story 1.6 preparation)

### Error Handling Strategy

**Database Errors:**
- Search not found (404)
- Unauthorized access to search (403)
- Database constraint violations
- Transaction failures

**Validation Errors:**
- Invalid search topic/description
- Invalid result type or content format
- Invalid sequence numbers for results
- Content size limitations

**Business Logic Errors:**
- Adding results to completed searches
- Invalid status transitions
- Duplicate result sequences

### Testing Strategy

**Test Framework**: Jest [Source: package.json]
**Test Categories:**
- **Unit Tests**: Search and SearchResult service functions
- **Integration Tests**: API endpoints with authentication
- **Database Tests**: Model relationships and constraints
- **Performance Tests**: Query efficiency and pagination
- **Error Tests**: All error scenarios and validation

**Test File Locations:**
- `tests/services/searchService.test.js`
- `tests/services/searchResultService.test.js`
- `tests/routes/search.test.js`
- `tests/models/search.test.js`

### Technical Constraints

**Performance Requirements:**
- Search list queries under 200ms
- Individual search retrieval under 100ms
- Support for searches with large result sets

**Storage Considerations:**
- Efficient storage of large text content
- Proper indexing for fast queries
- Content compression for large reports

**Security Considerations:**
- Validate all user inputs
- Sanitize search result content
- Prevent unauthorized search access
- Rate limiting for search creation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*Results from QA Agent review will be added here after implementation*