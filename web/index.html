<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search API Debug Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .auth-section {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .auth-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input, textarea, button, select {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .search-input {
            min-height: 80px;
            resize: vertical;
        }

        .stream-display {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }

        .stream-event {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .event-metadata {
            background: #e8f4fd;
            border-left: 4px solid #3498db;
        }

        .event-thinking {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .event-intermediate {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }

        .event-report {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .event-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .event-timestamp {
            color: #6c757d;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .search-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            padding: 5px;
        }

        .search-list::-webkit-scrollbar {
            width: 8px;
        }

        .search-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .search-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .search-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .search-item {
            padding: 10px;
            border-bottom: 1px solid #e1e8ed;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-item:hover {
            background: #f8f9fa;
        }

        .search-item.active {
            background: #e3f2fd;
            border-left: 4px solid #3498db;
        }

        .search-query {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .search-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-processing {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        .status-completed {
            background: #28a745;
        }

        .status-failed {
            background: #dc3545;
        }

        .status-initiated {
            background: #17a2b8;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connecting {
            background: #fff3cd;
            color: #856404;
        }

        .clear-btn {
            background: #6c757d;
            font-size: 12px;
            padding: 8px 12px;
        }

        .clear-btn:hover {
            background: #5a6268;
        }

        .user-switcher {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .user-button {
            padding: 12px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .user-button:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .user-button.active {
            border-color: #3498db;
            background: #e3f2fd;
            font-weight: 600;
        }

        .user-icon {
            font-size: 20px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-email {
            font-size: 11px;
            color: #7f8c8d;
        }

        .team-create-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .team-create-form input {
            flex: 1;
        }

        .team-card {
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }

        .team-role {
            font-size: 12px;
            padding: 4px 8px;
            background: #e74c3c;
            color: white;
            border-radius: 4px;
        }

        .member-section {
            margin-top: 15px;
        }

        .member-section h4 {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .member-badge {
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .member-remove {
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
        }

        .member-remove:hover {
            color: #c0392b;
        }

        .team-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .team-actions select {
            flex: 1;
        }

        .history-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .history-tabs button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #7f8c8d;
        }

        .history-tabs button:hover {
            color: #34495e;
        }

        .history-tabs button.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }

        .team-selector-container {
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .auth-form {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Search API Debug Interface</h1>
            <p class="subtitle">Real-time search streaming and API debugging tool</p>
        </header>

        <div class="section auth-section">
            <h2>üîê Token Generation</h2>
            <div class="auth-form">
                <button id="generateTokenBtn">Generate Token</button>
                <button id="useExistingTokenBtn" style="margin-left: 10px; background: #6c757d;">Use Existing Token</button>
                <span id="authStatus" class="connection-status disconnected">No token available</span>
            </div>
            <div id="existingTokenInput" style="display: none; margin-top: 15px;">
                <input type="text" id="manualToken" placeholder="Paste your existing token here..." style="width: 70%; margin-right: 10px;">
                <button id="saveTokenBtn">Save Token</button>
                <button id="cancelTokenBtn" style="background: #dc3545;">Cancel</button>
            </div>
        </div>

        <div class="section auth-section">
            <h2>üë• Demo Users</h2>
            <div class="user-switcher" id="userSwitcher">
                <!-- User buttons will be dynamically generated -->
            </div>
        </div>

        <div class="section auth-section">
            <h2>üè¢ Team Management</h2>
            <div class="team-create-form">
                <input type="text" id="teamNameInput" placeholder="Enter team name...">
                <button id="createTeamBtn" disabled>Create Team</button>
            </div>
            <div id="teamsList">
                <div style="color: #6c757d; text-align: center; padding: 20px;">
                    No teams yet. Create your first team!
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>üöÄ Search & Stream</h2>
                <div class="search-form">
                    <textarea
                        id="searchQuery"
                        class="search-input"
                        placeholder="Enter your investment research query..."
                        >Analyze the recent performance of Tesla stock and provide investment recommendations.</textarea>
                    <button id="startSearch" disabled>Start Streaming Search</button>
                    <button id="stopSearch" disabled>Stop Stream</button>
                </div>

                <div class="connection-status" id="streamStatus">
                    <span class="status-indicator"></span>
                    <span>Ready to connect</span>
                </div>

                <div class="stream-display" id="streamDisplay">
                    <div style="color: #6c757d; text-align: center; margin-top: 180px;">
                        Waiting for search stream...
                    </div>
                </div>

                <button class="clear-btn" id="clearStream">Clear Stream</button>
            </div>

            <div class="section">
                <h2>üìã Search History</h2>
                <div class="history-tabs">
                    <button id="personalTab" class="active">Personal History</button>
                    <button id="teamTab">Team History</button>
                </div>
                <div id="personalHistory">
                    <button id="refreshHistory">Refresh History</button>
                    <div class="search-list" id="searchList">
                        <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                            No searches yet
                        </div>
                    </div>
                </div>
                <div id="teamHistory" style="display: none;">
                    <div class="team-selector-container">
                        <label for="teamHistorySelector" style="display: block; margin-bottom: 8px; font-size: 14px; color: #7f8c8d;">Select Team:</label>
                        <select id="teamHistorySelector" style="width: 100%;">
                            <option value="">-- Select a team --</option>
                        </select>
                    </div>
                    <button id="refreshTeamHistory">Refresh Team History</button>
                    <div class="search-list" id="teamHistoryList">
                        <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                            Select a team to view history
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SearchDebugInterface {
            constructor() {
                this.baseURL = 'http://localhost:8080';
                this.authToken = null;
                this.currentSearchId = null;
                this.eventSource = null;
                this.currentUser = null;
                this.currentTeams = [];

                // Demo users configuration
                this.demoUsers = [
                    {
                        id: 'demo-alice',
                        name: 'Alice',
                        email: 'alice@demo.local',
                        color: '#3498db',
                        icon: 'üë©‚Äçüíº'
                    },
                    {
                        id: 'demo-bob',
                        name: 'Bob',
                        email: 'bob@demo.local',
                        color: '#2ecc71',
                        icon: 'üë®‚Äçüíª'
                    },
                    {
                        id: 'demo-carol',
                        name: 'Carol',
                        email: 'carol@demo.local',
                        color: '#e74c3c',
                        icon: 'üë©‚Äçüî¨'
                    }
                ];

                this.initializeElements();
                this.bindEvents();
                this.renderUserSwitcher();
                this.loadStoredAuth();
            }

            initializeElements() {
                this.generateTokenBtn = document.getElementById('generateTokenBtn');
                this.useExistingTokenBtn = document.getElementById('useExistingTokenBtn');
                this.saveTokenBtn = document.getElementById('saveTokenBtn');
                this.cancelTokenBtn = document.getElementById('cancelTokenBtn');
                this.manualToken = document.getElementById('manualToken');
                this.existingTokenInput = document.getElementById('existingTokenInput');
                this.authStatus = document.getElementById('authStatus');

                this.searchQuery = document.getElementById('searchQuery');
                this.startSearchBtn = document.getElementById('startSearch');
                this.stopSearchBtn = document.getElementById('stopSearch');
                this.streamStatus = document.getElementById('streamStatus');
                this.streamDisplay = document.getElementById('streamDisplay');
                this.clearStreamBtn = document.getElementById('clearStream');

                this.refreshHistoryBtn = document.getElementById('refreshHistory');
                this.searchList = document.getElementById('searchList');

                // New elements for team management
                this.userSwitcher = document.getElementById('userSwitcher');
                this.teamNameInput = document.getElementById('teamNameInput');
                this.createTeamBtn = document.getElementById('createTeamBtn');
                this.teamsList = document.getElementById('teamsList');

                // History tabs
                this.personalTab = document.getElementById('personalTab');
                this.teamTab = document.getElementById('teamTab');
                this.personalHistory = document.getElementById('personalHistory');
                this.teamHistory = document.getElementById('teamHistory');
                this.teamHistorySelector = document.getElementById('teamHistorySelector');
                this.refreshTeamHistoryBtn = document.getElementById('refreshTeamHistory');
                this.teamHistoryList = document.getElementById('teamHistoryList');
            }

            bindEvents() {
                this.generateTokenBtn.addEventListener('click', () => this.generateToken());
                this.useExistingTokenBtn.addEventListener('click', () => this.showExistingTokenInput());
                this.saveTokenBtn.addEventListener('click', () => this.saveExistingToken());
                this.cancelTokenBtn.addEventListener('click', () => this.hideExistingTokenInput());
                this.startSearchBtn.addEventListener('click', () => this.startSearch());
                this.stopSearchBtn.addEventListener('click', () => this.stopSearch());
                this.clearStreamBtn.addEventListener('click', () => this.clearStream());
                this.refreshHistoryBtn.addEventListener('click', () => this.loadSearchHistory());

                // Team management
                this.createTeamBtn.addEventListener('click', () => this.createTeam());
                this.teamNameInput.addEventListener('input', () => {
                    this.createTeamBtn.disabled = !this.teamNameInput.value.trim() || !this.authToken;
                });

                // History tabs
                this.personalTab.addEventListener('click', () => this.switchHistoryTab('personal'));
                this.teamTab.addEventListener('click', () => this.switchHistoryTab('team'));
                this.teamHistorySelector.addEventListener('change', () => this.loadTeamHistory());
                this.refreshTeamHistoryBtn.addEventListener('click', () => this.loadTeamHistory());

                // Ctrl+Enter for search
                this.searchQuery.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) this.startSearch();
                });
            }

            async generateToken() {
                // If a demo user is selected, generate token for that user
                if (this.currentUser) {
                    await this.generateTokenForUser(this.currentUser);
                    return;
                }

                // Otherwise, prompt user to select a demo user first
                this.showAuthStatus('Please select a user from the Demo Users section', 'disconnected');
            }

            showExistingTokenInput() {
                this.existingTokenInput.style.display = 'block';
                this.manualToken.focus();
            }

            hideExistingTokenInput() {
                this.existingTokenInput.style.display = 'none';
                this.manualToken.value = '';
            }

            saveExistingToken() {
                const token = this.manualToken.value.trim();
                if (!token) {
                    alert('Please enter a token');
                    return;
                }

                this.authToken = token;
                localStorage.setItem('authToken', this.authToken);
                localStorage.setItem('tokenUser', 'External User');

                this.showAuthStatus('Existing token saved successfully', 'connected');
                this.startSearchBtn.disabled = false;
                this.refreshHistoryBtn.disabled = false;
                this.hideExistingTokenInput();
                this.loadSearchHistory();
            }

            loadStoredAuth() {
                // Check for previously selected demo user, but don't auto-load token
                const currentDemoUserId = localStorage.getItem('currentDemoUser');
                if (currentDemoUserId) {
                    const demoUser = this.demoUsers.find(u => u.id === currentDemoUserId);

                    if (demoUser) {
                        // Set current user for UI display, but don't load token yet
                        this.currentUser = demoUser;
                        this.showAuthStatus(`${demoUser.name} selected. Click to generate token.`, 'disconnected');
                        // Re-render user switcher to show active state
                        this.renderUserSwitcher();
                        return;
                    }
                }

                // Show prompt to select a user
                this.showAuthStatus('Select a demo user to get started', 'disconnected');
            }

            showAuthStatus(message, status) {
                this.authStatus.textContent = message;
                this.authStatus.className = `connection-status ${status}`;
            }

            async startSearch() {
                const query = this.searchQuery.value.trim();
                if (!query) {
                    alert('Please enter a search query');
                    return;
                }

                if (!this.authToken) {
                    alert('Please login first');
                    return;
                }

                this.startSearchBtn.disabled = true;
                this.stopSearchBtn.disabled = false;
                this.updateStreamStatus('Starting search...', 'connecting');

                try {
                    const response = await fetch(`${this.baseURL}/api/search/stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ query })
                    });

                    const data = (await response.json()).data;

                    if (response.ok && data.searchId) {
                        this.currentSearchId = data.searchId;
                        this.connectToStream(data.searchId);
                        this.loadSearchHistory();
                    } else {
                        throw new Error(data.message || 'Failed to start search');
                    }
                } catch (error) {
                    this.updateStreamStatus(`Error: ${error.message}`, 'disconnected');
                    this.startSearchBtn.disabled = false;
                    this.stopSearchBtn.disabled = true;
                }
            }

            connectToStream(searchId) {
                this.closeStream();

                const streamUrl = `${this.baseURL}/api/search/stream/${searchId}?authorization=${encodeURIComponent(this.authToken)}`;
                this.eventSource = new EventSource(streamUrl);

                this.updateStreamStatus('Connected to stream', 'connected');

                this.eventSource.onopen = () => {
                    this.updateStreamStatus('Stream connected', 'connected');
                };

                this.eventSource.onmessage = (event) => {
                    this.handleStreamEvent('message', event.data);
                };

                this.eventSource.addEventListener('connected', (event) => {
                    this.handleStreamEvent('connected', event.data);
                });

                this.eventSource.addEventListener('METADATA', (event) => {
                    this.handleStreamEvent('METADATA', event.data);
                });

                this.eventSource.addEventListener('THINKING', (event) => {
                    this.handleStreamEvent('THINKING', event.data);
                });

                this.eventSource.addEventListener('INTERMEDIATE', (event) => {
                    this.handleStreamEvent('INTERMEDIATE', event.data);
                });

                this.eventSource.addEventListener('REPORT', (event) => {
                    this.handleStreamEvent('REPORT', event.data);
                });

                this.eventSource.addEventListener('result', (event) => {
                    this.handleStreamEvent('result', event.data);
                });

                this.eventSource.addEventListener('complete', (event) => {
                    this.handleStreamEvent('complete', event.data);
                });

                this.eventSource.addEventListener('status', (event) => {
                    this.handleStreamEvent('status', event.data);
                });

                this.eventSource.addEventListener('error', (event) => {
                    this.handleStreamEvent('error', event.data);
                });

                this.eventSource.addEventListener('heartbeat', (event) => {
                    // Silent heartbeat handling
                });

                this.eventSource.onerror = (error) => {
                    console.error('EventSource error:', error);
                    this.updateStreamStatus('Stream connection error', 'disconnected');
                    this.stopSearch();
                };
            }

            handleStreamEvent(type, data) {
                const timestamp = new Date().toLocaleTimeString();
                let eventClass = 'stream-event';
                let content = '';

                try {
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;

                    switch (type) {
                        case 'connected':
                            eventClass += ' event-metadata';
                            content = `Connected to search stream (ID: ${parsedData.searchId})`;
                            break;
                        case 'status':
                            eventClass += ' event-metadata';
                            content = `Status: ${parsedData.status} - ${parsedData.message || ''}`;
                            break;
                        case 'result':
                            // Handle result events with different types
                            const resultType = parsedData.type || 'UNKNOWN';
                            switch (resultType) {
                                case 'METADATA':
                                    eventClass += ' event-metadata';
                                    content = `Metadata: ${parsedData.content || JSON.stringify(parsedData)}`;
                                    break;
                                case 'THINKING':
                                    eventClass += ' event-thinking';
                                    content = `AI Thinking: ${parsedData.content || ''}`;
                                    break;
                                case 'INTERMEDIATE':
                                    eventClass += ' event-intermediate';
                                    content = `Intermediate Result: ${parsedData.content || ''}`;
                                    break;
                                case 'REPORT':
                                    eventClass += ' event-report';
                                    content = `Final Report:\n${parsedData.content || ''}`;
                                    break;
                                default:
                                    eventClass += ' event-intermediate';
                                    content = `Result [${resultType}]: ${parsedData.content || JSON.stringify(parsedData)}`;
                            }
                            break;
                        case 'complete':
                            eventClass += ' event-report';
                            content = `Search completed! Total results: ${parsedData.totalResults}, Duration: ${(parsedData.duration / 1000).toFixed(2)}s`;
                            this.stopSearch();
                            this.loadSearchHistory();
                            break;
                        case 'METADATA':
                            eventClass += ' event-metadata';
                            content = `Search metadata: ${JSON.stringify(parsedData, null, 2)}`;
                            break;
                        case 'THINKING':
                            eventClass += ' event-thinking';
                            content = `Thinking: ${parsedData.content || parsedData}`;
                            break;
                        case 'INTERMEDIATE':
                            eventClass += ' event-intermediate';
                            content = `Intermediate: ${parsedData.content || parsedData}`;
                            break;
                        case 'REPORT':
                            eventClass += ' event-report';
                            content = `Final Report:\n${parsedData.content || parsedData}`;
                            this.stopSearch();
                            this.loadSearchHistory();
                            break;
                        case 'error':
                            eventClass += ' event-error';
                            content = `Error: ${parsedData.message || parsedData}`;
                            this.stopSearch();
                            break;
                        default:
                            content = `${type}: ${typeof parsedData === 'object' ? JSON.stringify(parsedData, null, 2) : parsedData}`;
                    }
                } catch (e) {
                    content = `${type}: ${data}`;
                }

                const eventElement = document.createElement('div');
                eventElement.className = eventClass;
                eventElement.innerHTML = `
                    <div class="event-timestamp">${timestamp}</div>
                    <div class="event-content">${content}</div>
                `;

                this.streamDisplay.appendChild(eventElement);
                this.streamDisplay.scrollTop = this.streamDisplay.scrollHeight;
            }

            stopSearch() {
                this.closeStream();
                this.updateStreamStatus('Stream stopped', 'disconnected');
                this.startSearchBtn.disabled = false;
                this.stopSearchBtn.disabled = true;
                this.currentSearchId = null;
            }

            closeStream() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
            }

            clearStream() {
                this.streamDisplay.innerHTML = `
                    <div style="color: #6c757d; text-align: center; margin-top: 180px;">
                        Stream cleared - ready for new search
                    </div>
                `;
            }

            updateStreamStatus(message, status) {
                const indicator = this.streamStatus.querySelector('.status-indicator');
                const text = this.streamStatus.querySelector('span:last-child');

                indicator.className = `status-indicator status-${status}`;
                text.textContent = message;
            }

            async loadSearchHistory() {
                if (!this.authToken) return;

                try {
                    const response = await fetch(`${this.baseURL}/api/search/history`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.data) {
                        this.renderSearchHistory(data.data.queries);
                    }
                } catch (error) {
                    console.error('Failed to load search history:', error);
                }
            }

            renderSearchHistory(searches) {
                if (searches.length === 0) {
                    this.searchList.innerHTML = `
                        <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                            No searches yet
                        </div>
                    `;
                    return;
                }

                this.searchList.innerHTML = searches.map(search => {
                    // Determine status based on available data
                    const status = search.status || (search.totalResults > 0 ? 'completed' : 'processing');
                    const resultsText = search.totalResults !== undefined ? ` (${search.totalResults} results)` : '';

                    return `
                        <div class="search-item ${search.id === this.currentSearchId ? 'active' : ''}"
                             onclick="debugInterface.selectSearch('${search.id}')">
                            <div class="search-query">${search.query}</div>
                            <div class="search-meta">
                                <span class="status-indicator status-${status.toLowerCase()}"></span>
                                ${status.charAt(0).toUpperCase() + status.slice(1)}${resultsText} ‚Ä¢ ${new Date(search.createdAt).toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async selectSearch(searchId) {
                if (!this.authToken) return;

                try {
                    // Highlight selected search
                    this.currentSearchId = searchId;
                    const searchItems = this.searchList.querySelectorAll('.search-item');
                    searchItems.forEach(item => item.classList.remove('active'));
                    const selectedItem = this.searchList.querySelector(`[onclick*="${searchId}"]`);
                    if (selectedItem) selectedItem.classList.add('active');

                    // Clear stream display and show loading
                    this.streamDisplay.innerHTML = `
                        <div style="color: #6c757d; text-align: center; padding: 20px;">
                            Loading search results...
                        </div>
                    `;

                    // Fetch search results
                    const response = await fetch(`${this.baseURL}/api/search/${searchId}/results`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.data) {
                        this.displaySearchResults(data.data);
                    } else {
                        throw new Error(data.error || 'Failed to load search results');
                    }
                } catch (error) {
                    console.error('Failed to load search results:', error);
                    this.streamDisplay.innerHTML = `
                        <div style="color: #e74c3c; text-align: center; padding: 20px;">
                            Failed to load search results: ${error.message}
                        </div>
                    `;
                }
            }

            displaySearchResults(data) {
                const { query, createdAt, results } = data;

                if (!results || results.length === 0) {
                    this.streamDisplay.innerHTML = `
                        <div style="color: #6c757d; text-align: center; padding: 20px;">
                            No results found for this search
                        </div>
                    `;
                    return;
                }

                // Display query info and results
                let html = `
                    <div class="stream-event event-metadata">
                        <div class="event-timestamp">${new Date(createdAt).toLocaleString()}</div>
                        <div class="event-content"><strong>Query:</strong> ${query}</div>
                    </div>
                `;

                results.forEach(result => {
                    const eventType = result.resultType?.toLowerCase() || 'result';

                    // Try to parse content if it looks like JSON
                    let displayContent = result.content;
                    try {
                        // If content is a JSON string, try to extract meaningful text
                        if (displayContent.startsWith('{') || displayContent.startsWith('[')) {
                            const parsed = JSON.parse(displayContent);
                            // If it has a content field, use that
                            if (parsed.content) {
                                displayContent = parsed.content;
                            } else {
                                // Otherwise format the JSON nicely
                                displayContent = JSON.stringify(parsed, null, 2);
                            }
                        }
                    } catch (e) {
                        // Not JSON or failed to parse, use as-is
                    }

                    html += `
                        <div class="stream-event event-${eventType === 'intermediate' ? 'intermediate' : eventType === 'metadata' ? 'metadata' : 'report'}">
                            <div class="event-timestamp">${new Date(result.createdAt).toLocaleString()}</div>
                            <div class="event-content">
                                <strong>${result.title}</strong><br>
                                <pre style="white-space: pre-wrap; margin: 5px 0 0 0;">${displayContent}</pre>
                            </div>
                        </div>
                    `;
                });

                this.streamDisplay.innerHTML = html;
                this.streamDisplay.scrollTop = this.streamDisplay.scrollHeight;
            }

            // ===== Demo Users Methods =====
            renderUserSwitcher() {
                const currentUserId = this.currentUser?.id || localStorage.getItem('currentDemoUser');

                this.userSwitcher.innerHTML = this.demoUsers.map(user => {
                    const isActive = user.id === currentUserId;
                    return `
                        <button class="user-button ${isActive ? 'active' : ''}" data-user-id="${user.id}" style="border-color: ${user.color}20;">
                            <span class="user-icon">${user.icon}</span>
                            <div class="user-info">
                                <div>${user.name}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </button>
                    `;
                }).join('');

                // Add click handlers
                this.userSwitcher.querySelectorAll('.user-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.getAttribute('data-user-id');
                        this.switchUser(userId);
                    });
                });
            }

            async switchUser(userId) {
                const user = this.demoUsers.find(u => u.id === userId);
                if (!user) return;

                // Update UI to show loading
                const userButtons = this.userSwitcher.querySelectorAll('.user-button');
                userButtons.forEach(btn => btn.classList.remove('active'));
                const activeBtn = this.userSwitcher.querySelector(`[data-user-id="${userId}"]`);
                if (activeBtn) activeBtn.classList.add('active');

                // Clear all previous user's data from UI
                this.clearAllData();

                // Always generate new token (don't use cached token)
                this.currentUser = user;
                localStorage.setItem('currentDemoUser', userId);
                await this.generateTokenForUser(user);
            }

            clearAllData() {
                // Clear search history
                this.searchList.innerHTML = `
                    <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                        Loading...
                    </div>
                `;

                // Clear teams
                this.teamsList.innerHTML = `
                    <div style="color: #6c757d; text-align: center; padding: 20px;">
                        Loading...
                    </div>
                `;

                // Clear team history
                this.teamHistoryList.innerHTML = `
                    <div style="color: #6c757d; text-align: center; padding: 20px;">
                        Select a team to view history
                    </div>
                `;

                // Clear team selector
                this.teamHistorySelector.innerHTML = '<option value="">Select a team...</option>';

                // Clear stream display
                this.streamDisplay.innerHTML = '';

                // Reset current data
                this.currentTeams = [];
            }

            async generateTokenForUser(user) {
                try {
                    this.showAuthStatus(`Generating token for ${user.name}...`, 'connecting');

                    const response = await fetch(`${this.baseURL}/api/auth/generate-token`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            email: user.email,
                            name: user.name
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.access_token) {
                        this.authToken = data.access_token;
                        this.currentUser = user;
                        localStorage.setItem(`demoUser_${user.id}_token`, this.authToken);
                        localStorage.setItem('currentDemoUser', user.id);
                        this.showAuthStatus(`${user.name} logged in`, 'connected');
                        this.enableButtons();
                        await this.refreshAllData();
                    } else {
                        throw new Error(data.message || 'Token generation failed');
                    }
                } catch (error) {
                    this.showAuthStatus(`Failed to switch to ${user.name}: ${error.message}`, 'disconnected');
                }
            }

            enableButtons() {
                this.startSearchBtn.disabled = false;
                this.refreshHistoryBtn.disabled = false;
                this.createTeamBtn.disabled = !this.teamNameInput.value.trim();
            }

            showAuthStatus(message, status) {
                this.authStatus.textContent = message;
                this.authStatus.className = `connection-status ${status}`;
            }

            async refreshAllData() {
                await Promise.all([
                    this.loadSearchHistory(),
                    this.loadTeams()
                ]);
            }

            // ===== Team Management Methods =====
            async loadTeams() {
                if (!this.authToken) return;

                try {
                    const response = await fetch(`${this.baseURL}/api/teams`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.data) {
                        this.currentTeams = data.data;
                        this.renderTeams(data.data);
                        this.updateTeamSelector(data.data);
                    }
                } catch (error) {
                    console.error('Failed to load teams:', error);
                }
            }

            renderTeams(teams) {
                if (teams.length === 0) {
                    this.teamsList.innerHTML = `
                        <div style="color: #6c757d; text-align: center; padding: 20px;">
                            No teams yet. Create your first team!
                        </div>
                    `;
                    return;
                }

                this.teamsList.innerHTML = teams.map(team => `
                    <div class="team-card" data-team-id="${team.id}">
                        <div class="team-header">
                            <div class="team-name">${team.name}</div>
                            <div class="team-role">${team.role || 'member'}</div>
                        </div>
                        ${team.description ? `<div style="color: #7f8c8d; font-size: 13px; margin-bottom: 10px;">${team.description}</div>` : ''}
                        <div class="member-section">
                            <h4>Members:</h4>
                            <div class="member-list" id="members-${team.id}">
                                <span style="color: #7f8c8d;">Loading...</span>
                            </div>
                        </div>
                        <div class="team-actions">
                            <select id="member-select-${team.id}">
                                <option value="">-- Select user to add --</option>
                                ${this.demoUsers.map(u => `<option value="${u.id}">${u.icon} ${u.name}</option>`).join('')}
                            </select>
                            <button onclick="debugInterface.addMemberToTeam('${team.id}')">Add Member</button>
                        </div>
                    </div>
                `).join('');

                // Load members for each team
                teams.forEach(team => this.loadTeamMembers(team.id));
            }

            async loadTeamMembers(teamId) {
                if (!this.authToken) return;

                try {
                    const response = await fetch(`${this.baseURL}/api/teams/${teamId}/members`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.data) {
                        this.renderTeamMembers(teamId, data.data);
                    }
                } catch (error) {
                    console.error('Failed to load team members:', error);
                    const memberList = document.getElementById(`members-${teamId}`);
                    if (memberList) {
                        memberList.innerHTML = '<span style="color: #e74c3c;">Failed to load</span>';
                    }
                }
            }

            renderTeamMembers(teamId, members) {
                const memberList = document.getElementById(`members-${teamId}`);
                if (!memberList) return;

                if (members.length === 0) {
                    memberList.innerHTML = '<span style="color: #7f8c8d;">No members yet</span>';
                    return;
                }

                memberList.innerHTML = members.map(member => {
                    const user = this.demoUsers.find(u => u.id === member.userId);
                    const icon = user ? user.icon : 'üë§';
                    return `
                        <div class="member-badge">
                            <span>${icon} ${member.name}</span>
                            <span class="member-remove" onclick="debugInterface.removeMemberFromTeam('${teamId}', '${member.userId}')">√ó</span>
                        </div>
                    `;
                }).join('');
            }

            async createTeam() {
                const teamName = this.teamNameInput.value.trim();
                if (!teamName || !this.authToken) return;

                try {
                    this.createTeamBtn.disabled = true;
                    this.createTeamBtn.textContent = 'Creating...';

                    const response = await fetch(`${this.baseURL}/api/teams`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ name: teamName })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.teamNameInput.value = '';
                        await this.loadTeams();
                        alert(`Team "${teamName}" created successfully!`);
                    } else {
                        throw new Error(data.error || 'Failed to create team');
                    }
                } catch (error) {
                    alert(`Failed to create team: ${error.message}`);
                } finally {
                    this.createTeamBtn.disabled = false;
                    this.createTeamBtn.textContent = 'Create Team';
                }
            }

            async addMemberToTeam(teamId) {
                const selectElement = document.getElementById(`member-select-${teamId}`);
                const userIdToAdd = selectElement.value;

                if (!userIdToAdd || !this.authToken) {
                    alert('Please select a user to add');
                    return;
                }

                try {
                    const response = await fetch(`${this.baseURL}/api/teams/${teamId}/members`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ userIdToAdd })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        selectElement.value = '';
                        await this.loadTeamMembers(teamId);
                        alert('Member added successfully!');
                    } else {
                        throw new Error(data.error || 'Failed to add member');
                    }
                } catch (error) {
                    alert(`Failed to add member: ${error.message}`);
                }
            }

            async removeMemberFromTeam(teamId, userId) {
                if (!confirm('Remove this member from the team?')) return;

                try {
                    const response = await fetch(`${this.baseURL}/api/teams/${teamId}/members/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        await this.loadTeamMembers(teamId);
                        alert('Member removed successfully!');
                    } else {
                        throw new Error(data.error || 'Failed to remove member');
                    }
                } catch (error) {
                    alert(`Failed to remove member: ${error.message}`);
                }
            }

            // ===== History Tab Management =====
            switchHistoryTab(tab) {
                if (tab === 'personal') {
                    this.personalTab.classList.add('active');
                    this.teamTab.classList.remove('active');
                    this.personalHistory.style.display = 'block';
                    this.teamHistory.style.display = 'none';
                } else {
                    this.teamTab.classList.add('active');
                    this.personalTab.classList.remove('active');
                    this.teamHistory.style.display = 'block';
                    this.personalHistory.style.display = 'none';
                    if (this.currentTeams.length > 0 && !this.teamHistorySelector.value) {
                        this.updateTeamSelector(this.currentTeams);
                    }
                }
            }

            updateTeamSelector(teams) {
                this.teamHistorySelector.innerHTML = '<option value="">-- Select a team --</option>' +
                    teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('');
            }

            async loadTeamHistory() {
                const teamId = this.teamHistorySelector.value;
                if (!teamId || !this.authToken) {
                    this.teamHistoryList.innerHTML = `
                        <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                            Select a team to view history
                        </div>
                    `;
                    return;
                }

                try {
                    const response = await fetch(`${this.baseURL}/api/search/team/${teamId}`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    const data = await response.json();

                    if (response.ok && data.success && data.data) {
                        this.renderTeamHistory(data.data);
                    }
                } catch (error) {
                    console.error('Failed to load team history:', error);
                    this.teamHistoryList.innerHTML = `
                        <div style="color: #e74c3c; text-align: center; margin-top: 120px;">
                            Failed to load team history
                        </div>
                    `;
                }
            }

            renderTeamHistory(searches) {
                if (searches.length === 0) {
                    this.teamHistoryList.innerHTML = `
                        <div style="color: #6c757d; text-align: center; margin-top: 120px;">
                            No team searches yet
                        </div>
                    `;
                    return;
                }

                this.teamHistoryList.innerHTML = searches.map(search => {
                    const status = search.status || (search.resultCount > 0 ? 'completed' : 'processing');
                    const resultsText = search.resultCount !== undefined ? ` (${search.resultCount} results)` : '';

                    return `
                        <div class="search-item">
                            <div class="search-query">${search.topic}</div>
                            <div class="search-meta">
                                <span class="status-indicator status-${status.toLowerCase()}"></span>
                                ${status.charAt(0).toUpperCase() + status.slice(1)}${resultsText} ‚Ä¢
                                ${search.userName || 'Unknown'} ‚Ä¢
                                ${new Date(search.createdAt).toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Initialize the interface
        const debugInterface = new SearchDebugInterface();
    </script>
</body>
</html>